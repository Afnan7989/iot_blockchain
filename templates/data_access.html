{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-4 text-center">Stored IoT Data Records</h2>

<div class="card p-4">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle">
            <thead>
                <tr>
                    <th>IPFS CID</th>
                    <th>Blockchain Tx</th>
                    <th>Account</th>
                    <th>Stored At</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for record in records %}
                <tr>
                    <td class="text-truncate" style="max-width:180px;">
                        {{ record.ipfs_cid }}
                    </td>

                    <td class="text-truncate" style="max-width:160px;">
                        {{ record.blockchain_tx }}
                    </td>

                    <td class="text-truncate" style="max-width:160px;">
                        {{ record.blockchain_account }}
                    </td>

                    <td>{{ record.created_at|date:"Y-m-d H:i:s" }}</td>

                    <td>
                        <button
                            class="btn btn-sm btn-info"
                            onclick="openRecord('{{ record.ipfs_cid }}')">
                            View
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No records found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================= MODAL ================= -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-dark text-light">

            <div class="modal-header">
                <h5 class="modal-title">IoT Record Verification</h5>
                <button type="button"
                        class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <p id="verifyStatus" class="fw-bold mb-3"></p>

                <h6>Blockchain Proof</h6>
                <ul class="small">
                    <li><b>IPFS CID:</b> <span id="cidField"></span></li>
                    <li><b>Tx Hash:</b> <span id="txField"></span></li>
                    <li><b>Account:</b> <span id="accountField"></span></li>
                </ul>

                <hr>

                <h6>Encrypted Data (from IPFS)</h6>
                <pre id="encryptedData"
                     class="bg-black p-3 rounded small"></pre>

                <hr>

                <h6>Decrypted Data</h6>
                <pre id="decryptedData"
                     class="bg-black p-3 rounded small text-success"></pre>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Close
                </button>

                <button class="btn btn-success"
                        onclick="decryptData()">
                    Decrypt
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
let currentRecordData = null;
let encryptedPayload = null;

function openRecord(recordId) {
    showLoadingPopup('Verifying Record');

    fetch(`/view-record/${recordId}/`)
        .then(res => res.json())
        .then(data => {
            hideLoadingPopup();
            if (data.error) {
                showPopup('error', 'Verification Failed', data.error);
                return;
            }

            currentRecordData = data;
            encryptedPayload = data.encrypted_data;

            const blockchainData = {
                'IPFS CID': data.cid,
                'Blockchain TX': data.tx_hash,
                'Account Address': data.account_address,
            };

            const encryptedDataStr = JSON.stringify(encryptedPayload, null, 2);
            
            showPopup('success', 'âœ“ Verified on Blockchain', 'Record integrity verified. Click the action button to decrypt.', {
                ...blockchainData,
                'Encrypted Data': encryptedDataStr.substring(0, 100) + '...',
            });

            // Show decrypt button in popup
            showRecordDetailsPopup(data);
        })
        .catch(err => {
            hideLoadingPopup();
            showPopup('error', 'Error', 'Failed to fetch record: ' + err.message);
        });
}

function showRecordDetailsPopup(data) {
    const overlay = document.getElementById('popupOverlay');
    const titleText = document.getElementById('popupTitleText');
    const messageText = document.getElementById('popupMessage');
    const icon = document.getElementById('popupIcon');
    const dataContainer = document.getElementById('popupDataContainer');
    const footer = document.querySelector('.popup-footer');

    titleText.textContent = 'IoT Record Details';
    icon.className = 'popup-icon success bi bi-shield-check';
    
    messageText.innerHTML = '<strong>Blockchain Verification: âœ“ Verified</strong><p style="margin-top: 10px;">Record integrity confirmed on blockchain. Decrypt to view sensor data.</p>';

    dataContainer.innerHTML = '<div class="popup-data">';
    dataContainer.innerHTML += `<div class="popup-data-item">
        <span class="popup-data-label">IPFS CID:</span>
        <span class="popup-data-value" style="font-size: 12px;">${data.cid}</span>
    </div>`;
    dataContainer.innerHTML += `<div class="popup-data-item">
        <span class="popup-data-label">Blockchain TX:</span>
        <span class="popup-data-value" style="font-size: 12px;">${data.tx_hash}</span>
    </div>`;
    dataContainer.innerHTML += `<div class="popup-data-item">
        <span class="popup-data-label">Account:</span>
        <span class="popup-data-value" style="font-size: 12px;">${data.account_address}</span>
    </div>`;
    dataContainer.innerHTML += `<div class="popup-data-item">
        <span class="popup-data-label">Access Time:</span>
        <span class="popup-data-value">${data.access_time_taken} s</span>
    </div>`;
    dataContainer.innerHTML += `<div class="popup-data-item">
        <span class="popup-data-label">Hash Matched:</span>
        <span class="popup-data-value">${data.hash_matched ? 'âœ“ Yes' : 'âœ— No'}</span>
    </div>`;
    dataContainer.innerHTML += '</div>';

    footer.innerHTML = `
        <button class="popup-btn popup-btn-secondary" onclick="closePopup()">Close</button>
        <button class="popup-btn popup-btn-success" onclick="decryptData()">ðŸ”“ Decrypt Data</button>
    `;

    overlay.classList.add('show');
}

function decryptData() {
    if (!encryptedPayload) return;

    showLoadingPopup('Decrypting Data');

    fetch(`/decrypt-record/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(encryptedPayload)
    })
    .then(res => res.json())
    .then(data => {
        hideLoadingPopup();
        
        // Format decrypted data for display
        const displayData = {
            'Title': data.title,
            'Temperature': data.temperature + ' Â°C',
            'Humidity': data.humidity + ' %',
            'Air Pressure': data.air_pressure + ' hPa',
            'DateTime': data.datetime,
        };

        showPopup('success', 'ðŸ”“ Data Decrypted', 'Successfully decrypted sensor data from IPFS', displayData);
    })
    .catch(err => {
        hideLoadingPopup();
        showPopup('error', 'Decryption Failed', 'Unable to decrypt the data: ' + err.message);
    });
}

</script>

{% endblock %}
